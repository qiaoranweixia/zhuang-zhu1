<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸“æ³¨è®¡æ—¶å™¨ Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* ================= UI æ ·å¼éƒ¨åˆ†ï¼šä¿æŒä½ å–œæ¬¢çš„æå…‰ç»ç’ƒè®¾è®¡ ================= */
        :root {
            --primary: #00f2fe;
            --secondary: #4facfe;
            --accent: #ff0080;
            --glass-bg: rgba(15, 23, 42, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: #0f172a;
            color: var(--text-main);
            font-family: var(--font-family);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            position: relative;
            padding: 15px;
        }

        /* åŠ¨æ€æå…‰èƒŒæ™¯ */
        .aurora-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background:
                radial-gradient(circle at 10% 20%, rgba(79, 172, 254, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 128, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(0, 242, 254, 0.1) 0%, transparent 60%);
            z-index: -1;
            animation: breathe 10s ease-in-out infinite alternate;
        }
        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            width: 100%;
            max-width: 800px; /* ä¿æŒå®½å±è®¾è®¡ */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 10;
        }

        /* ä¸“æ³¨æ¨¡å¼ï¼šé™ä½éæ ¸å¿ƒå…ƒç´ é€æ˜åº¦ */
        body.focus-mode .container > *:not(.timer-section):not(.progress-container) {
            opacity: 0.3; filter: blur(1px); pointer-events: none; transition: opacity 0.5s ease;
        }
        body.focus-mode .controls {
            opacity: 1 !important; filter: none !important; pointer-events: auto !important;
        }

        header { text-align: center; margin-bottom: 40px; }
        h1 {
            font-size: 2.5rem; font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            margin-bottom: 10px;
        }
        .subtitle { color: var(--text-muted); font-size: 0.95rem; letter-spacing: 0.5px; }

        .timer-section { text-align: center; position: relative; margin: 20px 0; }

        .status-badge {
            display: inline-block; padding: 8px 20px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 10px; transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.1);
        }
        .status-badge.work { background: rgba(79, 172, 254, 0.15); color: #4facfe; box-shadow: 0 0 20px rgba(79,172,254,0.2); }
        .status-badge.short-break { background: rgba(0, 242, 254, 0.15); color: #00f2fe; box-shadow: 0 0 20px rgba(0,242,254,0.2); }
        .status-badge.long-break { background: rgba(255, 0, 128, 0.15); color: #ff0080; box-shadow: 0 0 20px rgba(255,0,128,0.2); }

        .timer-display {
            font-size: 6.5rem; font-weight: 300; font-family: 'Inter', monospace;
            line-height: 1; text-shadow: 0 10px 30px rgba(0,0,0,0.3); margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;
            margin: 30px 0 40px; cursor: pointer; position: relative; touch-action: none;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary));
            border-radius: 10px; width: 0%; position: relative; transition: width 0.2s linear; /* çº¿æ€§è¿‡æ¸¡ */
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.4);
        }
        .progress-handle {
            position: absolute; right: -10px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 15px rgba(255,255,255,0.8);
        }

        /* æŒ‰é’® */
        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .btn {
            padding: 18px 40px; border: none; border-radius: 16px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--primary)); color: #0f172a;
            box-shadow: 0 10px 30px -5px rgba(79, 172, 254, 0.4);
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 20px 40px -5px rgba(79, 172, 254, 0.5); }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-icon { padding: 15px; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* é¢æ¿ */
        .panel-toggle { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 20px; }
        .toggle-text { color: var(--text-muted); cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; }
        .toggle-text.active { color: var(--text-main); background: rgba(255,255,255,0.1); }

        .collapsible-panel { display: none; animation: fadeIn 0.4s ease; }
        .collapsible-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .grid-settings { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .setting-card { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .setting-card h3 { font-size: 1rem; margin-bottom: 15px; color: var(--text-muted); font-weight: 400; }

        /* è¾“å…¥æ§ä»¶ */
        input[type="range"] { width: 100%; height: 20px; background: transparent; appearance: none; outline: none; }
        input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; margin-top: -7px; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: pointer; }
        input[type="number"] { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px; border-radius: 8px; width: 80px; text-align: center; font-family: inherit; font-size: 1rem; }

        .sound-pills { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .sound-pill { padding: 6px 12px; border-radius: 20px; background: rgba(255,255,255,0.05); font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .sound-pill:hover { background: rgba(255,255,255,0.1); }
        .sound-pill.active { background: rgba(79, 172, 254, 0.15); border-color: var(--secondary); color: var(--secondary); }

        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1); opacity: 0; transition: all 0.4s; z-index: 1000; font-weight: 500;
        }
        .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .floating-note { position: fixed; font-size: 2rem; animation: floatUp 3s forwards ease-out; pointer-events: none; z-index: 50; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-150px) rotate(20deg); opacity: 0; } }

        /* éšè—çš„éŸ³é¢‘æ’­æ”¾å™¨ */
        #silent-player { display: none; }

        @media (max-width: 700px) {
            .container { padding: 25px; border-radius: 20px; }
            h1 { font-size: 2rem; }
            .timer-display { font-size: 4.5rem; }
            .btn { padding: 15px 30px; width: 100%; }
            .controls { flex-direction: column; gap: 15px; }
            .grid-settings { grid-template-columns: 1fr; }
            .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>

    <audio id="silent-player" loop playsinline>
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAASAA8AAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>

    <div class="container" id="main-container">
        <header>
            <h1>Focus Timer Pro</h1>
            <p class="subtitle">Web Audio åˆæˆéŸ³æ•ˆ Â· åå°ä¿æ´»å¢å¼ºç‰ˆ</p>
        </header>

        <div class="timer-section">
            <div class="status-badge work" id="status">å‡†å¤‡å¼€å§‹</div>
            <div class="timer-display" id="timer">90:00</div>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-handle" id="progress-handle"></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="start-btn">å¼€å§‹ä¸“æ³¨</button>
            <button class="btn btn-secondary btn-icon" id="reset-btn" title="é‡ç½®">â†»</button>
            <button class="btn btn-secondary btn-icon" id="mute-btn" title="é™éŸ³">ğŸ”Š</button>
        </div>

        <div class="panel-toggle">
            <div class="toggle-text" data-target="panel-settings">â±ï¸ è®¡æ—¶è®¾ç½®</div>
            <div class="toggle-text" data-target="panel-sound">ğŸµ éŸ³è‰²å®šåˆ¶</div>
        </div>

        <div class="collapsible-panel" id="panel-settings">
            <div class="grid-settings">
                <div class="setting-card">
                    <h3>æ—¶é—´é…ç½® (åˆ†é’Ÿ)</h3>
                    <div class="setting-row" style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label>ä¸“æ³¨æ—¶é•¿</label>
                        <input type="number" id="work-time" min="1" max="120" value="90">
                    </div>
                    <div class="setting-row" style="display:flex; justify-content:space-between;">
                        <label>ä¼‘æ¯æ—¶é•¿</label>
                        <input type="number" id="rest-time" min="1" max="60" value="20">
                    </div>
                </div>
                <div class="setting-card">
                    <h3>éšæœºæç¤ºé—´éš”</h3>
                    <div class="setting-row" style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label>æœ€çŸ­ (åˆ†)</label>
                        <input type="number" id="min-prompt" min="1" max="10" value="3">
                    </div>
                    <div class="setting-row" style="display:flex; justify-content:space-between;">
                        <label>æœ€é•¿ (åˆ†)</label>
                        <input type="number" id="max-prompt" min="2" max="15" value="5">
                    </div>
                </div>
            </div>
        </div>

        <div class="collapsible-panel" id="panel-sound">
            <div class="sound-pills" style="justify-content: center; margin-bottom: 20px;">
                <div class="sound-pill active" data-edit-target="work">å·¥ä½œéŸ³æ•ˆ</div>
                <div class="sound-pill" data-edit-target="shortBreak">çŸ­ä¼‘éŸ³æ•ˆ</div>
                <div class="sound-pill" data-edit-target="longBreak">é•¿ä¼‘éŸ³æ•ˆ</div>
            </div>

            <div class="grid-settings">
                <div class="setting-card">
                    <h3>åŸºç¡€å‚æ•°</h3>
                    <div style="margin-bottom:15px;">
                        <label style="display:flex; justify-content:space-between; font-size:0.85rem;">
                            <span>éŸ³é‡</span> <span id="val-volume">80%</span>
                        </label>
                        <input type="range" class="sound-param" id="volume" min="0" max="100">
                    </div>
                    <div style="margin-bottom:15px;">
                        <label style="display:flex; justify-content:space-between; font-size:0.85rem;">
                            <span>åŸºé¢‘ (Pitch)</span> <span id="val-pitch">ä¸­</span>
                        </label>
                        <input type="range" class="sound-param" id="pitch" min="0" max="100">
                    </div>
                    <div>
                        <label style="display:flex; justify-content:space-between; font-size:0.85rem;">
                            <span>å¿«é€Ÿé¢„è®¾</span>
                        </label>
                        <div class="sound-pills">
                            <div class="sound-pill" onclick="selectPreset('piano')">é’¢ç´</div>
                            <div class="sound-pill" onclick="selectPreset('bell')">é“ƒé“›</div>
                            <div class="sound-pill" onclick="selectPreset('gong')">é“œé”£</div>
                            <div class="sound-pill" onclick="selectPreset('beep')">ç”µå­</div>
                        </div>
                    </div>
                </div>

                <div class="setting-card">
                    <h3>æ³›éŸ³ç»“æ„ (Harmonics)</h3>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:0.8rem; color:var(--text-muted); display: flex; justify-content: space-between;">
                            <span>æ³›éŸ³1 (2x)</span>
                        </label>
                        <input type="range" class="sound-param harmonic" data-idx="0" min="0" max="100">
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:0.8rem; color:var(--text-muted); display: flex; justify-content: space-between;">
                            <span>æ³›éŸ³2 (3x)</span>
                        </label>
                        <input type="range" class="sound-param harmonic" data-idx="1" min="0" max="100">
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:0.8rem; color:var(--text-muted); display: flex; justify-content: space-between;">
                            <span>æ³›éŸ³3 (4x)</span>
                        </label>
                        <input type="range" class="sound-param harmonic" data-idx="2" min="0" max="100">
                    </div>
                    <div style="margin-top:15px; text-align:center;">
                         <button class="btn-secondary" style="padding:8px 20px; border-radius:20px; font-size:0.9rem; width:100%" id="test-sound-btn">â–¶ è¯•å¬å½“å‰é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; text-align: center; font-size: 0.8rem; color: var(--text-muted); opacity: 0.7;">
            ä¸“æ³¨æ¬¡æ•°: <span id="session-count">0</span> | çŠ¶æ€: <span id="current-mode-text">å·¥ä½œæ¨¡å¼</span>
        </div>
    </div>

    <div class="notification" id="notification">æç¤ºä¿¡æ¯</div>

    <script>
        /**
         * ==========================================
         * æ ¸å¿ƒä¿æ´»é€»è¾‘ï¼šTime-Delta Correction + Silent Audio
         * ==========================================
         */
        let audioContext;
        let soundEnabled = true;
        let editingSoundType = 'work';
        let currentSessionType = 'work';
        let wakeLock = null;

        // æ ¸å¿ƒè®¡æ—¶å˜é‡
        let isRunning = false;
        let targetEndTime = 0; // ç›®æ ‡ç»“æŸçš„æ—¶é—´æˆ³ï¼ˆç»å¯¹æ—¶é—´ï¼‰
        let timeLeft = 90 * 60;
        let totalTime = 90 * 60;
        let timerInterval = null;
        let promptTimeTarget = -1;

        // DOM
        const els = {
            timer: document.getElementById('timer'),
            status: document.getElementById('status'),
            progressBar: document.getElementById('progress-bar'),
            progressContainer: document.getElementById('progress-container'),
            startBtn: document.getElementById('start-btn'),
            resetBtn: document.getElementById('reset-btn'),
            muteBtn: document.getElementById('mute-btn'),
            notification: document.getElementById('notification'),
            silentPlayer: document.getElementById('silent-player'),
            inputs: {
                work: document.getElementById('work-time'),
                rest: document.getElementById('rest-time'),
                minP: document.getElementById('min-prompt'),
                maxP: document.getElementById('max-prompt')
            },
            soundControls: {
                volume: document.getElementById('volume'),
                pitch: document.getElementById('pitch'),
                harmonics: document.querySelectorAll('.harmonic')
            }
        };

        // é…ç½®
        const defaultSoundParams = {
            work: { type: 'piano', volume: 80, pitch: 50, harmonics: [40, 30, 20] },
            shortBreak: { type: 'bell', volume: 70, pitch: 75, harmonics: [30, 20, 10] },
            longBreak: { type: 'gong', volume: 90, pitch: 30, harmonics: [50, 40, 30] }
        };
        let appState = {
            soundParams: JSON.parse(JSON.stringify(defaultSoundParams)),
            settings: { workTime: 90, restTime: 20, minPrompt: 3, maxPrompt: 5 },
            stats: { sessionCount: 0 }
        };

        function init() {
            loadSettings();
            // ä¿æŒ 90/20 é»˜è®¤
            updateTimerUI(timeLeft, totalTime);
            bindEvents();
            updateSoundEditorUI();
            requestWakeLock(); // å°è¯•ç”³è¯·å”¤é†’é”
        }

        // æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨ Date.now() å·®å€¼è®¡ç®—ï¼Œé…åˆ Silent Audio
        function startTimer() {
            // A. æ’­æ”¾é™éŸ³éŸ³é¢‘ (ç§»åŠ¨ç«¯ä¿æ´»å…³é”®)
            els.silentPlayer.play().catch(e => console.warn("é™éŸ³éŸ³é¢‘æ’­æ”¾å—é˜»ï¼Œéœ€äº¤äº’", e));

            // B. æ¢å¤ AudioContext
            initAudioContext();

            // C. ç”³è¯·å”¤é†’é”
            requestWakeLock();

            isRunning = true;
            els.startBtn.textContent = "æš‚åœ";
            els.startBtn.classList.add('active');
            document.body.classList.add('focus-mode');

            // D. è®¾å®šç»å¯¹ç›®æ ‡æ—¶é—´
            targetEndTime = Date.now() + (timeLeft * 1000);

            if (currentSessionType === 'work' && promptTimeTarget === -1) {
                scheduleNextPrompt();
            }

            // E. å¯åŠ¨è½®è¯¢ (é¢‘ç‡ç¨é«˜ï¼Œæå‡åŠ¨ç”»æµç•…åº¦ï¼Œåæ­£è®¡ç®—æ˜¯åŸºäºç»å¯¹æ—¶é—´çš„)
            clearInterval(timerInterval);
            timerInterval = setInterval(tick, 200);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            els.silentPlayer.pause(); // æš‚åœä¿æ´»éŸ³é¢‘
            els.startBtn.textContent = "ç»§ç»­";
            document.body.classList.remove('focus-mode');
        }

        function resetTimer() {
            pauseTimer();
            currentSessionType = 'work';
            timeLeft = appState.settings.workTime * 60;
            totalTime = timeLeft;
            promptTimeTarget = -1;
            els.startBtn.textContent = "å¼€å§‹ä¸“æ³¨";
            updateTimerUI(timeLeft, totalTime);
            updateStatusUI();
            document.body.classList.remove('focus-mode');
        }

        function tick() {
            const now = Date.now();
            // æ ¸å¿ƒä¿®æ”¹3ï¼šä¸ä¾èµ– interval æ¬¡æ•°ï¼Œç›´æ¥ç®—å·®å€¼
            const remaining = Math.ceil((targetEndTime - now) / 1000);

            if (remaining !== timeLeft) {
                timeLeft = remaining;
                updateTimerUI(timeLeft, totalTime);

                // éšæœºæç¤º
                if (currentSessionType === 'work' && timeLeft === promptTimeTarget) {
                    triggerShortBreak();
                }

                // ç»“æŸé€»è¾‘
                if (timeLeft <= 0) {
                    switchPhase();
                }
            }
        }

        function switchPhase() {
            clearInterval(timerInterval);

            if (currentSessionType === 'work') {
                playSound('longBreak');
                showNotification("ä¸“æ³¨ç»“æŸï¼Œå¼€å§‹ä¼‘æ¯");
                appState.stats.sessionCount++;
                document.getElementById('session-count').textContent = appState.stats.sessionCount;
                saveSettings();

                currentSessionType = 'longBreak';
                timeLeft = appState.settings.restTime * 60;
            } else {
                playSound('work');
                showNotification("ä¼‘æ¯ç»“æŸï¼Œå¼€å§‹ä¸“æ³¨");
                currentSessionType = 'work';
                timeLeft = appState.settings.workTime * 60;
                promptTimeTarget = -1;
            }

            totalTime = timeLeft;
            updateStatusUI();

            // ç¨å¾®å»¶è¿Ÿåè‡ªåŠ¨ç»§ç»­ï¼ˆåˆ©ç”¨é™éŸ³éŸ³é¢‘ç»§ç»­ä¿æ´»ï¼‰
            setTimeout(() => startTimer(), 1000);
        }

        function triggerShortBreak() {
            const savedEndTime = targetEndTime; // ä¿å­˜ä¸»è®¡æ—¶å™¨çš„ç›®æ ‡ç»“æŸç‚¹
            clearInterval(timerInterval);

            playSound('shortBreak');
            createFloatingNote("â˜•");
            showNotification("æ”¾æ¾ 10 ç§’é’Ÿ...");

            let breakTime = 10;
            const tempTotal = 10;

            // ä¸´æ—¶ UI
            els.status.textContent = "æ”¾æ¾ 10 ç§’";
            els.status.className = "status-badge short-break";

            // çŸ­ä¼‘æ¯ä¹Ÿç”¨æ—¶é—´æˆ³é€»è¾‘
            const breakEnd = Date.now() + 10000;

            const breakInt = setInterval(() => {
                const now = Date.now();
                breakTime = Math.ceil((breakEnd - now) / 1000);

                updateTimerUI(breakTime, tempTotal); // å¤ç”¨æ›´æ–°å‡½æ•°

                if (breakTime <= 0) {
                    clearInterval(breakInt);
                    playSound('work');
                    updateStatusUI(); // æ¢å¤ UI

                    // æ¢å¤ä¸»è®¡æ—¶ï¼šå› ä¸ºæš‚åœäº†10ç§’ï¼Œç›®æ ‡æ—¶é—´è¦é¡ºå»¶10ç§’
                    targetEndTime = savedEndTime + 10000;
                    scheduleNextPrompt();

                    // æ¢å¤ä¸»å¾ªç¯
                    timerInterval = setInterval(tick, 200);
                }
            }, 200);
        }

        function scheduleNextPrompt() {
            const min = appState.settings.minPrompt * 60;
            const max = appState.settings.maxPrompt * 60;
            if (timeLeft > max + 60) {
                const interval = Math.floor(Math.random() * (max - min + 1)) + min;
                promptTimeTarget = timeLeft - interval;
            } else {
                promptTimeTarget = -2;
            }
        }

        // UI æ›´æ–°
        function updateTimerUI(seconds, total) {
            if (seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            els.timer.textContent = `${m}:${s}`;

            if (isRunning) document.title = `${m}:${s} - ä¸“æ³¨`;

            const progress = total > 0 ? ((total - seconds) / total) * 100 : 0;
            els.progressBar.style.width = `${progress}%`;
        }

        function updateStatusUI() {
            const map = { work: 'ä¸“æ³¨å·¥ä½œ', shortBreak: 'å¿«é€Ÿæ”¾æ¾', longBreak: 'ä¼‘æ¯æ—¶é—´' };
            const cls = { work: 'work', shortBreak: 'short-break', longBreak: 'long-break' };
            els.status.className = `status-badge ${cls[currentSessionType]}`;
            els.status.textContent = map[currentSessionType];
            document.getElementById('current-mode-text').textContent = map[currentSessionType] + "æ¨¡å¼";
        }

        // äº‹ä»¶ç»‘å®š
        function bindEvents() {
            els.startBtn.addEventListener('click', () => {
                if(isRunning) pauseTimer(); else startTimer();
            });
            els.resetBtn.addEventListener('click', resetTimer);
            els.muteBtn.addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                els.muteBtn.textContent = soundEnabled ? "ğŸ”Š" : "ğŸ”‡";
            });

            // è¿›åº¦æ¡æ‹–æ‹½
            const handleDrag = (e) => {
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const rect = els.progressContainer.getBoundingClientRect();
                let pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));

                // æ ¸å¿ƒä¿®æ”¹ï¼šæ‹–æ‹½æ—¶æ›´æ–°ç›®æ ‡æ—¶é—´ï¼Œé˜²æ­¢æ¾æ‰‹è·³å›
                const newTime = Math.floor(totalTime * (1 - pct));
                if (isRunning) {
                    targetEndTime = Date.now() + newTime * 1000;
                }
                timeLeft = newTime;
                updateTimerUI(timeLeft, totalTime);
            };
            els.progressContainer.addEventListener('mousedown', (e) => {
                handleDrag(e);
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', () => document.removeEventListener('mousemove', handleDrag), {once:true});
            });
            els.progressContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleDrag(e);
                document.addEventListener('touchmove', handleDrag, {passive:false});
                document.addEventListener('touchend', () => document.removeEventListener('touchmove', handleDrag), {once:true});
            }, {passive:false});

            // è®¾ç½®ä¸é¢æ¿é€»è¾‘
            document.querySelectorAll('.toggle-text').forEach(el => {
                el.addEventListener('click', () => {
                    const targetId = el.dataset.target;
                    const panel = document.getElementById(targetId);
                    const isHidden = panel.style.display !== 'block';
                    document.querySelectorAll('.collapsible-panel').forEach(p => p.style.display = 'none');
                    document.querySelectorAll('.toggle-text').forEach(t => t.classList.remove('active'));
                    if(isHidden) {
                        panel.style.display = 'block';
                        el.classList.add('active');
                    }
                });
            });

            // éŸ³è‰²åˆ‡æ¢
            document.querySelectorAll('[data-edit-target]').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('[data-edit-target]').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    editingSoundType = pill.dataset.editTarget;
                    updateSoundEditorUI();
                });
            });

            // æ»‘å—è¾“å…¥
            [els.soundControls.volume, els.soundControls.pitch, ...els.soundControls.harmonics].forEach(input => {
                input.addEventListener('input', () => {
                    const params = appState.soundParams[editingSoundType];
                    params.volume = parseInt(els.soundControls.volume.value);
                    params.pitch = parseInt(els.soundControls.pitch.value);
                    els.soundControls.harmonics.forEach((h, i) => params.harmonics[i] = parseInt(h.value));
                    document.getElementById('val-volume').textContent = params.volume + '%';
                    saveSettings();
                });
            });

            document.getElementById('test-sound-btn').addEventListener('click', () => {
                initAudioContext();
                playSound(editingSoundType);
            });

            // æ—¶é—´è®¾ç½®
            const updateTimes = () => {
                appState.settings.workTime = parseInt(els.inputs.work.value);
                appState.settings.restTime = parseInt(els.inputs.rest.value);
                appState.settings.minPrompt = parseInt(els.inputs.minP.value);
                appState.settings.maxPrompt = parseInt(els.inputs.maxP.value);
                saveSettings();
                if (!isRunning) resetTimer();
            };
            Object.values(els.inputs).forEach(inp => inp.addEventListener('change', updateTimes));
        }

        // éŸ³é¢‘ä¸Šä¸‹æ–‡
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        function playSound(type) {
            if (!soundEnabled || !audioContext) return;
            const params = appState.soundParams[type];
            const now = audioContext.currentTime;

            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.type = params.type === 'bell' ? 'sine' : (params.type === 'gong' ? 'sine' : 'triangle');
            if (params.type === 'piano') osc.type = 'sine';

            let freq = 440 * (0.5 + params.pitch/100);
            if (params.type === 'gong') freq = 150 * (0.5 + params.pitch/100);
            if (params.type === 'bell') freq = 800 * (0.5 + params.pitch/100);

            osc.frequency.setValueAtTime(freq, now);

            const vol = params.volume / 100;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 2.5);

            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(now);
            osc.stop(now + 3.0);

            // æ³›éŸ³
            params.harmonics.forEach((h, i) => {
                if (h > 0) {
                    const hOsc = audioContext.createOscillator();
                    const hGain = audioContext.createGain();
                    hOsc.frequency.value = freq * (i + 2);
                    const hVol = (h/100) * vol;
                    hGain.gain.setValueAtTime(0, now);
                    hGain.gain.linearRampToValueAtTime(hVol, now + 0.05);
                    hGain.gain.exponentialRampToValueAtTime(0.001, now + 2.0);
                    hOsc.connect(hGain);
                    hGain.connect(audioContext.destination);
                    hOsc.start(now);
                    hOsc.stop(now + 3.0);
                }
            });
        }

        // è¾…åŠ©
        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
        }

        function createFloatingNote(char) {
            const note = document.createElement('div');
            note.className = 'floating-note';
            note.textContent = char;
            note.style.left = Math.random() * 60 + 20 + '%';
            note.style.top = '50%';
            note.style.color = `hsl(${Math.random()*360}, 80%, 70%)`;
            document.body.appendChild(note);
            setTimeout(() => note.remove(), 4000);
        }

        function showNotification(msg) {
            els.notification.textContent = msg;
            els.notification.classList.add('show');
            setTimeout(() => els.notification.classList.remove('show'), 2500);
        }

        function updateSoundEditorUI() {
            const params = appState.soundParams[editingSoundType];
            els.soundControls.volume.value = params.volume;
            els.soundControls.pitch.value = params.pitch;
            document.getElementById('val-volume').textContent = params.volume + '%';
            els.soundControls.harmonics.forEach((h, i) => {
                if(params.harmonics[i] !== undefined) h.value = params.harmonics[i];
            });
        }

        function loadSettings() {
            const saved = localStorage.getItem('focus_pro_final');
            if (saved) {
                const d = JSON.parse(saved);
                if(d.settings) appState.settings = d.settings;
                if(d.soundParams) appState.soundParams = d.soundParams;
                if(d.stats) appState.stats = d.stats;
            }
            els.inputs.work.value = appState.settings.workTime;
            els.inputs.rest.value = appState.settings.restTime;
            els.inputs.minP.value = appState.settings.minPrompt;
            els.inputs.maxP.value = appState.settings.maxPrompt;
            document.getElementById('session-count').textContent = appState.stats.sessionCount;

            // æ›´æ–°åˆå§‹æ—¶é—´
            timeLeft = appState.settings.workTime * 60;
            totalTime = timeLeft;
        }

        function saveSettings() {
            localStorage.setItem('focus_pro_final', JSON.stringify(appState));
        }

        window.selectPreset = function(type) {
            const presets = {
                piano: { pitch: 50, harmonics: [40, 30, 20] },
                bell: { pitch: 75, harmonics: [30, 20, 10] },
                gong: { pitch: 30, harmonics: [50, 40, 30] },
                beep: { pitch: 60, harmonics: [0, 0, 0] }
            };
            if (presets[type]) {
                Object.assign(appState.soundParams[editingSoundType], presets[type], {type});
                updateSoundEditorUI();
                initAudioContext();
                playSound(editingSoundType);
                saveSettings();
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
