<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸“æ³¨è®¡æ—¶å™¨ Pro (åå°ä¿æ´»ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* ä¿æŒåŸæœ‰çš„ç²¾è‡´ UI æ ·å¼ */
        :root {
            --primary: #00f2fe;
            --secondary: #4facfe;
            --accent: #ff0080;
            --glass-bg: rgba(15, 23, 42, 0.85); /*ç¨å¾®åŠ æ·±èƒŒæ™¯ä»¥é€‚åº”ç§»åŠ¨ç«¯*/
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: #0f172a;
            color: var(--text-main);
            font-family: var(--font-family);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            position: relative;
            padding: 15px;
        }

        .aurora-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(79, 172, 254, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 128, 0.15) 0%, transparent 40%);
            z-index: -1;
            animation: breathe 10s ease-in-out infinite alternate;
        }
        @keyframes breathe { 0% { opacity: 0.6; } 100% { opacity: 0.9; } }

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 30px 25px;
            width: 100%;
            max-width: 600px; /* ç¨å¾®è°ƒçª„é€‚åº”æ‰‹æœº */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            position: relative;
            z-index: 10;
        }

        /* ä¸“æ³¨æ¨¡å¼ï¼šæç®€æ˜¾ç¤º */
        body.focus-mode .container > *:not(.timer-section):not(.progress-container):not(.controls) {
            opacity: 0.3; filter: blur(2px); pointer-events: none; transition: 0.5s;
        }

        header { text-align: center; margin-bottom: 20px; }
        h1 {
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .subtitle { color: var(--text-muted); font-size: 0.85rem; }

        .timer-section { text-align: center; margin: 20px 0; }
        .status-badge {
            display: inline-block; padding: 6px 16px; border-radius: 50px;
            font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);
        }
        .status-badge.work { background: rgba(79, 172, 254, 0.15); color: #4facfe; }
        .status-badge.short-break { background: rgba(0, 242, 254, 0.15); color: #00f2fe; }
        .status-badge.long-break { background: rgba(255, 0, 128, 0.15); color: #ff0080; }

        .timer-display {
            font-size: 5.5rem; font-weight: 300; font-family: 'Inter', monospace;
            line-height: 1; text-shadow: 0 5px 20px rgba(0,0,0,0.4);
            font-variant-numeric: tabular-nums;
        }

        .progress-container {
            height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px;
            margin: 25px 0 35px; cursor: pointer; position: relative; touch-action: none;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary));
            border-radius: 10px; width: 0%; transition: width 0.2s linear;
        }
        .progress-handle {
            position: absolute; right: -12px; top: 50%; transform: translateY(-50%);
            width: 24px; height: 24px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .controls { display: flex; gap: 15px; margin-bottom: 20px; }
        .btn {
            padding: 18px 0; border: none; border-radius: 16px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer; flex: 1;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: #0f172a; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1); }
        .btn-icon { flex: 0 0 56px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;}

        /* é¢æ¿åˆ‡æ¢ä¸è®¾ç½® */
        .panel-toggle { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .toggle-text { color: var(--text-muted); padding: 8px 15px; font-size: 0.9rem; border-radius: 8px; }
        .toggle-text.active { color: #fff; background: rgba(255,255,255,0.1); }

        .collapsible-panel { display: none; }
        .collapsible-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .grid-settings { display: grid; gap: 15px; }
        .setting-card { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.95rem;}
        
        input[type="number"] {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 8px; border-radius: 8px; width: 60px; text-align: center; font-size: 1rem;
        }
        input[type="range"] { width: 100%; height: 24px; background: transparent; appearance: none; }
        input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; margin-top: -9px; width: 24px; height: 24px; background: var(--primary); border-radius: 50%; }

        .sound-pills { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .sound-pill { flex: 1; text-align: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.85rem; }
        .sound-pill.active { background: rgba(79, 172, 254, 0.2); color: var(--primary); border: 1px solid var(--secondary); }

        .notification {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 999; width: 80%; text-align: center;
        }
        .notification.show { opacity: 1; }

        /* éšè—çš„ Audio æ’­æ”¾å™¨ï¼Œç”¨äºåå°ä¿æ´» */
        #silent-player { display: none; }

        @media (max-width: 400px) {
            .timer-display { font-size: 4.5rem; }
            h1 { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>
    
    <audio id="silent-player" loop playsinline>
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAASAA8AAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>

    <div class="container">
        <header>
            <h1>Focus Timer Pro</h1>
            <p class="subtitle">åå°å¸¸é©» Â· æ¯å±å¯ç”¨</p>
        </header>
        
        <div class="timer-section">
            <div class="status-badge work" id="status">å‡†å¤‡å°±ç»ª</div>
            <div class="timer-display" id="timer">90:00</div>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-handle"></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="start-btn">å¼€å§‹ä¸“æ³¨</button>
            <button class="btn btn-secondary btn-icon" id="reset-btn">â†»</button>
            <button class="btn btn-secondary btn-icon" id="mute-btn">ğŸ”Š</button>
        </div>

        <div class="panel-toggle">
            <div class="toggle-text active" data-target="panel-settings">è®¾ç½®</div>
            <div class="toggle-text" data-target="panel-sound">éŸ³æ•ˆ</div>
        </div>

        <div class="collapsible-panel active" id="panel-settings">
            <div class="grid-settings">
                <div class="setting-card">
                    <div class="setting-row"><label>ä¸“æ³¨æ—¶é•¿ (åˆ†)</label> <input type="number" id="work-time" value="90"></div>
                    <div class="setting-row"><label>ä¼‘æ¯æ—¶é•¿ (åˆ†)</label> <input type="number" id="rest-time" value="20"></div>
                </div>
                <div class="setting-card">
                    <div class="setting-row"><label>æœ€çŸ­éšæœºæç¤º (åˆ†)</label> <input type="number" id="min-prompt" value="3"></div>
                    <div class="setting-row"><label>æœ€é•¿éšæœºæç¤º (åˆ†)</label> <input type="number" id="max-prompt" value="5"></div>
                </div>
            </div>
        </div>

        <div class="collapsible-panel" id="panel-sound">
            <div class="setting-card">
                <div class="sound-pills">
                    <div class="sound-pill active" data-edit-target="work">å·¥ä½œ</div>
                    <div class="sound-pill" data-edit-target="shortBreak">çŸ­ä¼‘</div>
                    <div class="sound-pill" data-edit-target="longBreak">é•¿ä¼‘</div>
                </div>
                <div class="sound-pills">
                    <div class="sound-pill" onclick="selectPreset('piano')">é’¢ç´</div>
                    <div class="sound-pill" onclick="selectPreset('bell')">é“ƒé“›</div>
                    <div class="sound-pill" onclick="selectPreset('gong')">é“œé”£</div>
                </div>
                <div class="setting-row" style="margin-top:15px;">
                    <span>éŸ³é‡</span> <span id="val-volume">80%</span>
                </div>
                <input type="range" id="volume" min="0" max="100">
            </div>
            <button class="btn btn-secondary" style="width:100%; margin-top:15px; padding:10px;" id="test-sound-btn">è¯•å¬éŸ³æ•ˆ</button>
        </div>

        <div style="text-align: center; margin-top: 20px; font-size: 0.8rem; color: var(--text-muted); opacity: 0.6;">
            ä¸“æ³¨æ¬¡æ•°: <span id="session-count">0</span>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // ================== æ ¸å¿ƒè®¡æ—¶ä¸ä¿æ´»é€»è¾‘ ==================
        
        let audioContext;
        let wakeLock = null;
        let timerInterval;
        let targetEndTime = 0; // ç›®æ ‡ç»“æŸæ—¶é—´æˆ³ (æ ¸å¿ƒä¿®æ­£æœºåˆ¶)
        
        // çŠ¶æ€å˜é‡
        let isRunning = false;
        let currentDuration = 90 * 60;
        let timeLeft = 90 * 60;
        let currentSessionType = 'work'; // work, shortBreak, longBreak
        let promptTimeTarget = -1;
        let soundEnabled = true;
        let editingSoundType = 'work';

        // é…ç½®ä¸DOM
        const els = {
            timer: document.getElementById('timer'),
            progressBar: document.getElementById('progress-bar'),
            status: document.getElementById('status'),
            startBtn: document.getElementById('start-btn'),
            silentPlayer: document.getElementById('silent-player') // æ ¸å¿ƒä¿æ´»å…ƒç´ 
        };

        const appState = {
            settings: { workTime: 90, restTime: 20, minPrompt: 3, maxPrompt: 5 },
            soundParams: {
                work: { type: 'piano', volume: 80, pitch: 50, harmonics: [40, 30, 20] },
                shortBreak: { type: 'bell', volume: 70, pitch: 75, harmonics: [30, 20, 10] },
                longBreak: { type: 'gong', volume: 90, pitch: 30, harmonics: [50, 40, 30] }
            },
            stats: { sessionCount: 0 }
        };

        function init() {
            loadSettings();
            updateDisplay();
            bindEvents();
            // åˆå§‹åŒ–æ—¶ç”³è¯· WakeLock (è™½ç„¶ç‚¹å‡»æ—¶ç”³è¯·æ›´ç¨³ï¼Œä½†è¿™é‡Œå…ˆå°è¯•)
            requestWakeLock();
        }

        function bindEvents() {
            els.startBtn.addEventListener('click', () => {
                if (isRunning) pauseTimer();
                else startTimer();
            });
            
            document.getElementById('reset-btn').addEventListener('click', resetTimer);
            
            // ç»‘å®šè®¾ç½®è¾“å…¥
            document.getElementById('work-time').addEventListener('change', (e) => {
                appState.settings.workTime = parseInt(e.target.value);
                if (!isRunning && currentSessionType === 'work') {
                    currentDuration = appState.settings.workTime * 60;
                    timeLeft = currentDuration;
                    updateDisplay();
                }
                saveSettings();
            });
            document.getElementById('rest-time').addEventListener('change', (e) => {
                appState.settings.restTime = parseInt(e.target.value);
                saveSettings();
            });
            
            // è¿›åº¦æ¡æ‹–æ‹½
            const progressContainer = document.getElementById('progress-container');
            const handleDrag = (e) => {
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const rect = progressContainer.getBoundingClientRect();
                let pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                
                // æ‹–æ‹½æ—¶æ›´æ–°ç›®æ ‡æ—¶é—´
                const newTimeLeft = Math.floor(currentDuration * (1 - pct));
                
                // å¦‚æœæ­£åœ¨è¿è¡Œï¼Œéœ€è¦åŒæ—¶è°ƒæ•´ç›®æ ‡ç»“æŸæ—¶é—´æˆ³ï¼Œå¦åˆ™æ¾æ‰‹åä¼šè·³å›å»
                if (isRunning) {
                    targetEndTime = Date.now() + newTimeLeft * 1000;
                }
                timeLeft = newTimeLeft;
                updateDisplay();
            };
            progressContainer.addEventListener('touchstart', (e) => { e.preventDefault(); handleDrag(e); document.addEventListener('touchmove', handleDrag); });
            document.addEventListener('touchend', () => document.removeEventListener('touchmove', handleDrag));
            progressContainer.addEventListener('mousedown', (e) => { handleDrag(e); document.addEventListener('mousemove', handleDrag); });
            document.addEventListener('mouseup', () => document.removeEventListener('mousemove', handleDrag));

            // é¢æ¿åˆ‡æ¢
            document.querySelectorAll('.toggle-text').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.toggle-text').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.collapsible-panel').forEach(p => p.classList.remove('active'));
                    el.classList.add('active');
                    document.getElementById(el.dataset.target).classList.add('active');
                });
            });
            
            // éŸ³é‡è°ƒèŠ‚
            const volInput = document.getElementById('volume');
            volInput.addEventListener('input', (e) => {
                appState.soundParams[editingSoundType].volume = e.target.value;
                document.getElementById('val-volume').textContent = e.target.value + '%';
                saveSettings();
            });

            document.getElementById('test-sound-btn').addEventListener('click', () => {
                initAudioContext();
                playSound(editingSoundType);
            });

            // éŸ³æ•ˆåˆ‡æ¢
            document.querySelectorAll('[data-edit-target]').forEach(p => {
                p.addEventListener('click', () => {
                    document.querySelectorAll('[data-edit-target]').forEach(i => i.classList.remove('active'));
                    p.classList.add('active');
                    editingSoundType = p.dataset.editTarget;
                    volInput.value = appState.soundParams[editingSoundType].volume;
                    document.getElementById('val-volume').textContent = volInput.value + '%';
                });
            });
        }

        // ================== æ ¸å¿ƒè®¡æ—¶é€»è¾‘ (é˜²æ¼‚ç§»ç‰ˆ) ==================

        function startTimer() {
            // 1. å¯åŠ¨é™éŸ³éŸ³é¢‘ (ç§»åŠ¨ç«¯ä¿æ´»å…³é”®)
            els.silentPlayer.play().catch(e => console.log("é™éŸ³æ’­æ”¾å¤±è´¥(éœ€äº¤äº’):", e));
            
            // 2. åˆå§‹åŒ– WebAudio
            initAudioContext();
            
            // 3. ç”³è¯·å±å¹•å”¤é†’é”
            requestWakeLock();

            isRunning = true;
            document.body.classList.add('focus-mode');
            els.startBtn.textContent = "æš‚åœ";
            els.startBtn.style.background = "rgba(255,255,255,0.1)"; // è§†è§‰åé¦ˆ
            
            // 4. è®¾å®šç›®æ ‡æ—¶é—´æˆ³ (å½“å‰æ—¶é—´ + å‰©ä½™æ¯«ç§’)
            targetEndTime = Date.now() + (timeLeft * 1000);
            
            // 5. å¦‚æœæ˜¯å·¥ä½œæ¨¡å¼ä¸”æœªè®¾å®šéšæœºæç¤ºï¼Œè®¾å®šä¸€ä¸ª
            if (currentSessionType === 'work' && promptTimeTarget === -1) {
                scheduleNextPrompt();
            }

            // 6. å¯åŠ¨è®¡æ—¶å™¨ (é«˜é¢‘æ£€æµ‹ï¼Œè‡ªé€‚åº”ä¿®æ­£)
            clearInterval(timerInterval);
            timerInterval = setInterval(tick, 200); // æ¯200msæ£€æŸ¥ä¸€æ¬¡ï¼Œæ¯”1ç§’æ›´ä¸æ»‘
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            els.silentPlayer.pause(); // æš‚åœä¿æ´»éŸ³é¢‘
            document.body.classList.remove('focus-mode');
            els.startBtn.textContent = "ç»§ç»­";
            els.startBtn.style.background = "";
        }

        function resetTimer() {
            pauseTimer();
            currentSessionType = 'work';
            currentDuration = appState.settings.workTime * 60;
            timeLeft = currentDuration;
            promptTimeTarget = -1;
            updateStatusText();
            updateDisplay();
            els.startBtn.textContent = "å¼€å§‹ä¸“æ³¨";
        }

        function tick() {
            const now = Date.now();
            // ä½¿ç”¨å·®å€¼è®¡ç®—ï¼Œå³ä½¿æ¯å±1å°æ—¶ï¼Œå”¤é†’åä¹Ÿä¼šç¬é—´ç®—å‡ºæ­£ç¡®æ—¶é—´
            const remainingSeconds = Math.ceil((targetEndTime - now) / 1000);

            if (remainingSeconds !== timeLeft) {
                timeLeft = remainingSeconds;
                updateDisplay();
                
                // éšæœºæç¤ºé€»è¾‘
                if (currentSessionType === 'work' && timeLeft === promptTimeTarget) {
                    triggerShortBreak();
                }
                
                // å€’è®¡æ—¶ç»“æŸ
                if (timeLeft <= 0) {
                    handlePhaseComplete();
                }
            }
        }

        function handlePhaseComplete() {
            clearInterval(timerInterval);
            
            if (currentSessionType === 'work') {
                playSound('longBreak');
                showNotification("ä¸“æ³¨ç»“æŸï¼Œå¼€å§‹ä¼‘æ¯ï¼");
                appState.stats.sessionCount++;
                document.getElementById('session-count').textContent = appState.stats.sessionCount;
                saveSettings();
                
                currentSessionType = 'longBreak';
                currentDuration = appState.settings.restTime * 60;
                
            } else {
                playSound('work');
                showNotification("ä¼‘æ¯ç»“æŸï¼Œå¼€å§‹ä¸“æ³¨ï¼");
                currentSessionType = 'work';
                currentDuration = appState.settings.workTime * 60;
                promptTimeTarget = -1;
            }
            
            timeLeft = currentDuration;
            updateStatusText();
            updateDisplay();
            
            // è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€é˜¶æ®µ (ä¿æŒåå°è¿è¡Œ)
            setTimeout(() => startTimer(), 1000); 
        }

        function triggerShortBreak() {
            // æš‚åœä¸»è®¡æ—¶
            const savedEndTime = targetEndTime;
            clearInterval(timerInterval);
            
            playSound('shortBreak');
            showNotification("æ”¾æ¾ä¸€ä¸‹...");
            
            let breakLeft = 10;
            const tempDuration = 10;
            
            // ä¸´æ—¶åˆ‡æ¢UI
            els.status.textContent = "æ”¾æ¾ 10 ç§’";
            els.status.className = "status-badge short-break";
            
            // çŸ­ä¼‘æ¯ä¹Ÿä½¿ç”¨æ—¶é—´æˆ³é€»è¾‘ï¼Œé˜²æ­¢æ¯å±å¡ä½
            const breakEnd = Date.now() + 10000;
            
            const breakInt = setInterval(() => {
                const now = Date.now();
                breakLeft = Math.ceil((breakEnd - now) / 1000);
                
                els.timer.textContent = `00:${breakLeft.toString().padStart(2, '0')}`;
                els.progressBar.style.width = `${((tempDuration - breakLeft) / tempDuration) * 100}%`;
                
                if (breakLeft <= 0) {
                    clearInterval(breakInt);
                    playSound('work');
                    updateStatusText();
                    
                    // æ¢å¤ä¸»è®¡æ—¶ï¼šæ­¤æ—¶è¦æ³¨æ„ï¼Œæˆ‘ä»¬â€œæš‚åœâ€äº†10ç§’ï¼Œæ‰€ä»¥ç›®æ ‡ç»“æŸæ—¶é—´è¦é¡ºå»¶10ç§’
                    targetEndTime = savedEndTime + 10000; 
                    
                    // é‡æ–°è®¡ç®—æ–°çš„æç¤ºæ—¶é—´
                    scheduleNextPrompt();
                    
                    // æ¢å¤ä¸»å¾ªç¯
                    timerInterval = setInterval(tick, 200);
                }
            }, 200);
        }

        function scheduleNextPrompt() {
            const min = parseInt(document.getElementById('min-prompt').value) * 60;
            const max = parseInt(document.getElementById('max-prompt').value) * 60;
            if (timeLeft > max + 60) {
                const interval = Math.floor(Math.random() * (max - min + 1)) + min;
                promptTimeTarget = timeLeft - interval;
            } else {
                promptTimeTarget = -2; // ä¸å†æç¤º
            }
        }

        // ================== è¾…åŠ©åŠŸèƒ½ ==================

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            els.timer.textContent = `${m}:${s}`;
            const pct = Math.max(0, Math.min(100, ((currentDuration - timeLeft) / currentDuration) * 100));
            els.progressBar.style.width = `${pct}%`;
            els.progressBar.querySelector('.progress-handle').style.right = `${-12}px`; // ç®€å•ä¿®æ­£
            
            if (isRunning) document.title = `${m}:${s} - ${currentSessionType === 'work' ? 'ä¸“æ³¨' : 'ä¼‘æ¯'}`;
        }

        function updateStatusText() {
            const map = { work: 'ä¸“æ³¨ä¸­', shortBreak: 'çŸ­ä¼‘', longBreak: 'é•¿ä¼‘' };
            const cls = { work: 'work', shortBreak: 'short-break', longBreak: 'long-break' };
            els.status.textContent = map[currentSessionType];
            els.status.className = `status-badge ${cls[currentSessionType]}`;
        }

        // Wake Lock (å±å¹•å¸¸äº®)
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log('Wake Lock å¤±è´¥', err); }
        }

        // Web Audio æ’­æ”¾
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        function playSound(type) {
            if (!audioContext) initAudioContext();
            const params = appState.soundParams[type];
            
            const now = audioContext.currentTime;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.type = params.type === 'bell' ? 'sine' : (params.type === 'gong' ? 'sine' : 'triangle');
            if (params.type === 'piano') osc.type = 'sine';

            // ç®€å•é¢‘ç‡æ˜ å°„
            let freq = 440; 
            if (params.type === 'gong') freq = 150;
            if (params.type === 'bell') freq = 800;
            freq *= (0.5 + params.pitch/100);

            osc.frequency.setValueAtTime(freq, now);
            
            const vol = params.volume / 100;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 2.0); // ç»Ÿä¸€è¡°å‡

            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(now);
            osc.stop(now + 2.5);

            // ç®€å•çš„æ³›éŸ³æ¨¡æ‹Ÿ
            params.harmonics.forEach((h, i) => {
                if (h > 0) {
                    const hOsc = audioContext.createOscillator();
                    const hGain = audioContext.createGain();
                    hOsc.frequency.value = freq * (i + 2);
                    hGain.gain.setValueAtTime(0, now);
                    hGain.gain.linearRampToValueAtTime(vol * (h/100), now + 0.05);
                    hGain.gain.exponentialRampToValueAtTime(0.001, now + 2.0);
                    hOsc.connect(hGain);
                    hGain.connect(audioContext.destination);
                    hOsc.start(now);
                    hOsc.stop(now + 2.5);
                }
            });
        }

        // é…ç½®å­˜å–
        function loadSettings() {
            const saved = localStorage.getItem('timer_pro_bg_fix');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.settings) appState.settings = data.settings;
                if (data.soundParams) appState.soundParams = data.soundParams;
                if (data.stats) appState.stats = data.stats;
            }
            
            // åŒæ­¥UI
            document.getElementById('work-time').value = appState.settings.workTime;
            document.getElementById('rest-time').value = appState.settings.restTime;
            document.getElementById('min-prompt').value = appState.settings.minPrompt;
            document.getElementById('max-prompt').value = appState.settings.maxPrompt;
            document.getElementById('session-count').textContent = appState.stats.sessionCount;
            currentDuration = appState.settings.workTime * 60;
            timeLeft = currentDuration;
        }

        function saveSettings() {
            localStorage.setItem('timer_pro_bg_fix', JSON.stringify(appState));
        }

        // é¢„è®¾é€‰æ‹©
        window.selectPreset = function(preset) {
            const presets = {
                piano: { type:'piano', pitch: 50, harmonics: [40,30,20] },
                bell: { type:'bell', pitch: 80, harmonics: [30,20,10] },
                gong: { type:'gong', pitch: 20, harmonics: [60,50,40] }
            };
            if (presets[preset]) {
                Object.assign(appState.soundParams[editingSoundType], presets[preset]);
                showNotification(`å·²åº”ç”¨ ${preset} éŸ³è‰²`);
                saveSettings();
            }
        }

        function showNotification(msg) {
            const el = document.getElementById('notification');
            el.textContent = msg; el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
