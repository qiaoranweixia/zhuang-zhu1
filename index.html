<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸“æ³¨è®¡æ—¶å™¨ Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2fe;
            --secondary: #4facfe;
            --accent: #ff0080;
            --glass-bg: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: #0f172a;
            color: var(--text-main);
            font-family: var(--font-family);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            position: relative;
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            padding: 15px;
        }

        /* åŠ¨æ€æå…‰èƒŒæ™¯ */
        .aurora-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background:
                radial-gradient(circle at 10% 20%, rgba(79, 172, 254, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 128, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(0, 242, 254, 0.1) 0%, transparent 60%);
            z-index: -1;
            animation: breathe 10s ease-in-out infinite alternate;
        }
        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 10;
        }

        /* ä¸“æ³¨æ¨¡å¼ */
        body.focus-mode .container > *:not(.timer-section):not(.progress-container) {
            opacity: 0.2;
            filter: blur(2px);
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        body.focus-mode .controls {
            opacity: 1 !important;
            filter: none !important;
            pointer-events: auto !important;
        }

        header { text-align: center; margin-bottom: 30px; }
        h1 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 5px;
        }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; }

        /* è®¡æ—¶å™¨åŒºåŸŸ */
        .timer-section { text-align: center; position: relative; margin: 20px 0; }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-badge.work { background: rgba(79, 172, 254, 0.15); color: #4facfe; }
        .status-badge.short-break { background: rgba(0, 242, 254, 0.15); color: #00f2fe; }
        .status-badge.long-break { background: rgba(255, 0, 128, 0.15); color: #ff0080; }

        .timer-display {
            font-size: 6rem;
            font-weight: 300;
            font-family: 'Inter', monospace;
            line-height: 1;
            text-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            height: 10px; /* æ‰‹æœºç«¯åŠ ç²—ä¸€ç‚¹æ–¹ä¾¿ç‚¹ */
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 25px 0 35px;
            cursor: pointer;
            position: relative;
            touch-action: none; /* é˜²æ­¢æ‹–åŠ¨æ—¶æ»šåŠ¨å±å¹• */
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            border-radius: 10px;
            width: 0%;
            position: relative;
        }

        .progress-handle {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* æŒ‰é’® */
        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }

        .btn {
            padding: 16px 35px;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            flex: 1; /* ç§»åŠ¨ç«¯è‡ªé€‚åº” */
            min-width: 120px;
            max-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: #0f172a;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-main);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-icon { padding: 0; width: 54px; height: 54px; border-radius: 50%; flex: 0 0 54px; min-width: 54px;}

        /* è®¾ç½®é¢æ¿ */
        .panel-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 15px;
        }
        .toggle-text {
            color: var(--text-muted);
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 12px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .toggle-text.active { color: var(--text-main); background: rgba(255,255,255,0.1); }

        .collapsible-panel { display: none; animation: fadeIn 0.3s ease; }
        .collapsible-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .grid-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .setting-card {
            background: rgba(0,0,0,0.25);
            padding: 15px 20px;
            border-radius: 16px;
        }
        .setting-card h3 { font-size: 0.95rem; margin-bottom: 12px; color: var(--text-muted); }

        .setting-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
        }

        /* æ»‘å—ä¼˜åŒ– */
        input[type="range"] {
            width: 100%;
            height: 20px; /* å¢å¤§è§¦æ‘¸åŒº */
            background: transparent;
            appearance: none;
            outline: none;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            margin-top: -7px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
        }

        input[type="number"] {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            padding: 8px;
            border-radius: 8px;
            width: 70px;
            text-align: center;
            font-size: 1rem;
        }

        .sound-pills { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 20px; justify-content: center;}
        .sound-pill {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .sound-pill.active { background: rgba(79, 172, 254, 0.2); border-color: var(--secondary); color: var(--primary); }

        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 24px; border-radius: 50px;
            opacity: 0; transition: all 0.3s; z-index: 1000; font-size: 0.95rem; width: max-content;
            max-width: 90%; text-align: center; pointer-events: none;
        }
        .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .floating-note {
            position: fixed; font-size: 2.5rem; animation: floatUp 4s forwards ease-out;
            pointer-events: none; z-index: 50;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-200px) rotate(20deg); opacity: 0; }
        }

        /* ç§»åŠ¨ç«¯ç‰¹åˆ«é€‚é… */
        @media (max-width: 600px) {
            .container { padding: 25px 20px; border-radius: 24px; }
            .timer-display { font-size: 4.8rem; }
            h1 { font-size: 1.8rem; }
            .controls { gap: 10px; }
            .btn { padding: 15px 0; font-size: 1rem; }
            .grid-settings { grid-template-columns: 1fr; }
            .sound-pills { justify-content: space-between; }
            .sound-pill { flex: 1; text-align: center; padding: 8px 4px; font-size: 0.8rem;}
        }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>

    <div class="container" id="main-container">
        <header>
            <h1>Focus Timer Pro</h1>
            <p class="subtitle">Web Audio åˆæˆéŸ³æ•ˆ Â· æ¯å±ä¿æ´»æŠ€æœ¯</p>
        </header>

        <div class="timer-section">
            <div class="status-badge work" id="status">å‡†å¤‡å¼€å§‹</div>
            <div class="timer-display" id="timer">90:00</div>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-handle" id="progress-handle"></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="start-btn">å¼€å§‹ä¸“æ³¨</button>
            <button class="btn btn-secondary btn-icon" id="reset-btn" title="é‡ç½®">â†»</button>
            <button class="btn btn-secondary btn-icon" id="mute-btn" title="é™éŸ³">ğŸ”Š</button>
        </div>

        <div class="panel-toggle">
            <div class="toggle-text" data-target="panel-settings">âš™ï¸ å¸¸ç”¨è®¾ç½®</div>
            <div class="toggle-text" data-target="panel-sound">ğŸµ éŸ³è‰²å®šåˆ¶</div>
        </div>

        <div class="collapsible-panel" id="panel-settings">
            <div class="grid-settings">
                <div class="setting-card">
                    <h3>æ—¶é—´é…ç½® (åˆ†é’Ÿ)</h3>
                    <div class="setting-row">
                        <label>ä¸“æ³¨æ—¶é•¿</label>
                        <input type="number" id="work-time" min="1" max="240" value="90">
                    </div>
                    <div class="setting-row">
                        <label>ä¼‘æ¯æ—¶é•¿</label>
                        <input type="number" id="rest-time" min="1" max="60" value="20">
                    </div>
                </div>
                <div class="setting-card">
                    <h3>éšæœºæç¤º (é˜²èµ°ç¥)</h3>
                    <div class="setting-row">
                        <label>æœ€çŸ­é—´éš”</label>
                        <input type="number" id="min-prompt" min="1" max="30" value="3">
                    </div>
                    <div class="setting-row">
                        <label>æœ€é•¿é—´éš”</label>
                        <input type="number" id="max-prompt" min="2" max="60" value="5">
                    </div>
                </div>
            </div>
        </div>

        <div class="collapsible-panel" id="panel-sound">
            <div class="sound-pills">
                <div class="sound-pill active" data-edit-target="work">å·¥ä½œéŸ³æ•ˆ</div>
                <div class="sound-pill" data-edit-target="shortBreak">çŸ­ä¼‘éŸ³æ•ˆ</div>
                <div class="sound-pill" data-edit-target="longBreak">é•¿ä¼‘éŸ³æ•ˆ</div>
            </div>

            <div class="grid-settings">
                <div class="setting-card">
                    <div class="setting-row">
                        <label>é¢„è®¾é£æ ¼</label>
                    </div>
                    <div class="sound-pills" style="margin: 0 0 15px;">
                        <div class="sound-pill" onclick="selectPreset('piano')">é’¢ç´</div>
                        <div class="sound-pill" onclick="selectPreset('bell')">é“ƒé“›</div>
                        <div class="sound-pill" onclick="selectPreset('gong')">é“œé”£</div>
                        <div class="sound-pill" onclick="selectPreset('beep')">ç”µå­</div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <div class="setting-row"><span>éŸ³é‡</span> <span id="val-volume">80%</span></div>
                        <input type="range" id="volume" min="0" max="100">
                    </div>
                    <div style="margin-bottom:15px;">
                        <div class="setting-row"><span>éŸ³é«˜ (Pitch)</span> <span id="val-pitch">ä¸­</span></div>
                        <input type="range" id="pitch" min="0" max="100">
                    </div>
                </div>

                <div class="setting-card">
                    <h3>æ³›éŸ³è°ƒèŠ‚ (Harmonics)</h3>
                    <div class="setting-row"><small>æ³›éŸ³ 1</small> <input type="range" class="harmonic" data-idx="0" min="0" max="100" style="width:60%"></div>
                    <div class="setting-row"><small>æ³›éŸ³ 2</small> <input type="range" class="harmonic" data-idx="1" min="0" max="100" style="width:60%"></div>
                    <div class="setting-row"><small>æ³›éŸ³ 3</small> <input type="range" class="harmonic" data-idx="2" min="0" max="100" style="width:60%"></div>
                    <div style="text-align:center; margin-top:10px;">
                         <button class="btn-secondary" style="padding:8px 20px; border-radius:20px; font-size:0.85rem; width:100%" id="test-sound-btn">â–¶ è¯•å¬éŸ³æ•ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; text-align: center; font-size: 0.8rem; color: var(--text-muted); opacity: 0.7;">
            ä¸“æ³¨æ¬¡æ•°: <span id="session-count">0</span> | çŠ¶æ€: <span id="current-mode-text">å·¥ä½œ</span>
        </div>
    </div>

    <div class="notification" id="notification">æç¤ºä¿¡æ¯</div>

    <script id="worker-script" type="javascript/worker">
        let timerId;
        self.onmessage = function(e) {
            if (e.data === 'start') {
                // ä½¿ç”¨ setInterval åœ¨ Worker çº¿ç¨‹ä¸­è®¡æ—¶ï¼Œé¿å…ä¸»çº¿ç¨‹è¢«æŒ‚èµ·
                timerId = setInterval(() => {
                    postMessage('tick');
                }, 1000);
            } else if (e.data === 'stop') {
                clearInterval(timerId);
            }
        };
    </script>

    <script>
        /**
         * æ ¸å¿ƒå˜é‡ä¸çŠ¶æ€
         */
        let audioContext;
        let soundEnabled = true;
        let editingSoundType = 'work';
        let currentSessionType = 'work';
        let wakeLock = null; // å±å¹•å”¤é†’é”

        // åˆå§‹åŒ– Web Worker
        const workerBlob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
        const timerWorker = new Worker(URL.createObjectURL(workerBlob));

        const defaultSoundParams = {
            work: { type: 'piano', volume: 80, pitch: 50, decay: 60, brightness: 70, harmonics: [40, 30, 20, 10] },
            shortBreak: { type: 'bell', volume: 70, pitch: 75, decay: 40, brightness: 80, harmonics: [30, 20, 10, 5] },
            longBreak: { type: 'gong', volume: 90, pitch: 30, decay: 90, brightness: 60, harmonics: [50, 40, 30, 20] }
        };

        // é»˜è®¤è®¾ç½®ï¼š90åˆ†é’Ÿå·¥ä½œï¼Œ20åˆ†é’Ÿä¼‘æ¯
        let appState = {
            soundParams: JSON.parse(JSON.stringify(defaultSoundParams)),
            settings: {
                workTime: 90,
                restTime: 20,
                minPrompt: 3,
                maxPrompt: 5
            },
            stats: { sessionCount: 0 }
        };

        let isRunning = false;
        let timeLeft = 0;
        let totalTime = 0;
        let promptTimeTarget = 0;

        // DOM å…ƒç´ 
        const els = {
            timer: document.getElementById('timer'),
            status: document.getElementById('status'),
            progressBar: document.getElementById('progress-bar'),
            progressContainer: document.getElementById('progress-container'),
            startBtn: document.getElementById('start-btn'),
            resetBtn: document.getElementById('reset-btn'),
            muteBtn: document.getElementById('mute-btn'),
            notification: document.getElementById('notification'),
            inputs: {
                work: document.getElementById('work-time'),
                rest: document.getElementById('rest-time'),
                minP: document.getElementById('min-prompt'),
                maxP: document.getElementById('max-prompt')
            },
            soundControls: {
                volume: document.getElementById('volume'),
                pitch: document.getElementById('pitch'),
                harmonics: document.querySelectorAll('.harmonic')
            }
        };

        /**
         * åˆå§‹åŒ–
         */
        function init() {
            loadSettings();
            updateTimerUI(appState.settings.workTime * 60, appState.settings.workTime * 60);
            timeLeft = appState.settings.workTime * 60;
            totalTime = timeLeft;

            bindEvents();
            updateSoundEditorUI();
        }

        function loadSettings() {
            const saved = localStorage.getItem('focusTimerState_Pro');
            if (saved) {
                const parsed = JSON.parse(saved);
                if(parsed.settings) appState.settings = {...appState.settings, ...parsed.settings};
                if(parsed.soundParams) appState.soundParams = parsed.soundParams;
                if(parsed.stats) appState.stats = parsed.stats;
            }
            // åŒæ­¥åˆ° UI
            els.inputs.work.value = appState.settings.workTime;
            els.inputs.rest.value = appState.settings.restTime;
            els.inputs.minP.value = appState.settings.minPrompt;
            els.inputs.maxP.value = appState.settings.maxPrompt;
            document.getElementById('session-count').textContent = appState.stats.sessionCount;
        }

        function saveSettings() {
            localStorage.setItem('focusTimerState_Pro', JSON.stringify(appState));
        }

        /**
         * å±å¹•å¸¸äº®æ§åˆ¶ (Wake Lock API)
         * è¿™æ˜¯æ‰‹æœºç«¯æ¯å±ä¹Ÿèƒ½è¿è¡Œçš„å…³é”®è¾…åŠ©ï¼ˆé˜²æ­¢ç³»ç»Ÿæ€åå°ï¼‰
         */
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('å±å¹•å”¤é†’é”å·²æ¿€æ´»');
                }
            } catch (err) {
                console.log('Wake Lock Error:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        /**
         * éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ– (å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»æ—¶è§¦å‘)
         */
        function initAudioContext() {
            if (!audioContext) {
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContext();
                    // æ’­æ”¾ä¸€ä¸ªæçŸ­çš„é™éŸ³ä»¥è§£é” iOS éŸ³é¢‘é™åˆ¶
                    const buffer = audioContext.createBuffer(1, 1, 22050);
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                } catch (e) {
                    console.error(e);
                }
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        /**
         * äº‹ä»¶ç»‘å®š
         */
        function bindEvents() {
            // Worker æ¶ˆæ¯ç›‘å¬ (ä»£æ›¿ setInterval)
            timerWorker.onmessage = function(e) {
                if (e.data === 'tick') {
                    tick();
                }
            };

            els.startBtn.addEventListener('click', () => {
                initAudioContext(); // æ¿€æ´»éŸ³é¢‘
                toggleTimer();
            });

            els.resetBtn.addEventListener('click', resetTimer);
            els.muteBtn.addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                els.muteBtn.textContent = soundEnabled ? "ğŸ”Š" : "ğŸ”‡";
                showNotification(soundEnabled ? "å£°éŸ³å¼€å¯" : "é™éŸ³æ¨¡å¼");
            });

            // é¢æ¿æŠ˜å 
            document.querySelectorAll('.toggle-text').forEach(el => {
                el.addEventListener('click', () => {
                    const targetId = el.dataset.target;
                    const targetPanel = document.getElementById(targetId);
                    const isActive = targetPanel.style.display === 'block';

                    document.querySelectorAll('.collapsible-panel').forEach(p => p.style.display = 'none');
                    document.querySelectorAll('.toggle-text').forEach(t => t.classList.remove('active'));

                    if (!isActive) {
                        targetPanel.style.display = 'block';
                        el.classList.add('active');
                    }
                });
            });

            // è®¾ç½®å˜æ›´
            Object.values(els.inputs).forEach(input => {
                input.addEventListener('change', updateTimeSettings);
            });

            // éŸ³è‰²ç¼–è¾‘
            document.querySelectorAll('[data-edit-target]').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('[data-edit-target]').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    editingSoundType = pill.dataset.editTarget;
                    updateSoundEditorUI();
                });
            });

            // æ»‘å—å®æ—¶æ›´æ–°
            [els.soundControls.volume, els.soundControls.pitch, ...els.soundControls.harmonics].forEach(input => {
                input.addEventListener('input', () => {
                    const params = appState.soundParams[editingSoundType];
                    params.volume = parseInt(els.soundControls.volume.value);
                    params.pitch = parseInt(els.soundControls.pitch.value);
                    els.soundControls.harmonics.forEach((h, i) => params.harmonics[i] = parseInt(h.value));

                    document.getElementById('val-volume').textContent = params.volume + '%';
                    saveSettings();
                });
            });

            document.getElementById('test-sound-btn').addEventListener('click', () => {
                initAudioContext();
                playSound(editingSoundType);
            });

            // æ‹–æ‹½è¿›åº¦æ¡ (æ”¯æŒ Touch äº‹ä»¶)
            const handleDrag = (e) => {
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const rect = els.progressContainer.getBoundingClientRect();
                let pct = (clientX - rect.left) / rect.width;
                pct = Math.max(0, Math.min(1, pct));
                timeLeft = Math.floor(totalTime * (1 - pct));
                updateTimerUI(timeLeft, totalTime);
            };

            els.progressContainer.addEventListener('mousedown', (e) => {
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', () => document.removeEventListener('mousemove', handleDrag), {once:true});
                handleDrag(e);
            });

            els.progressContainer.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                document.addEventListener('touchmove', handleDrag, {passive: false});
                document.addEventListener('touchend', () => document.removeEventListener('touchmove', handleDrag), {once:true});
                handleDrag(e);
            }, {passive: false});
        }

        function updateTimeSettings() {
            appState.settings.workTime = parseInt(els.inputs.work.value);
            appState.settings.restTime = parseInt(els.inputs.rest.value);
            appState.settings.minPrompt = parseInt(els.inputs.minP.value);
            appState.settings.maxPrompt = parseInt(els.inputs.maxP.value);
            saveSettings();
            if (!isRunning) resetTimer();
        }

        /**
         * è®¡æ—¶é€»è¾‘ (ç”± Worker é©±åŠ¨)
         */
        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            isRunning = true;
            els.startBtn.textContent = "æš‚åœ";
            els.startBtn.classList.add('active');
            document.body.classList.add('focus-mode');

            // ç”³è¯·å±å¹•å¸¸äº® (ç§»åŠ¨ç«¯å…³é”®)
            requestWakeLock();

            if (currentSessionType === 'work' && promptTimeTarget === 0) {
                scheduleNextPrompt();
            }

            // å¯åŠ¨ Worker
            timerWorker.postMessage('start');
        }

        function pauseTimer() {
            isRunning = false;
            timerWorker.postMessage('stop'); // åœæ­¢ Worker
            releaseWakeLock(); // é‡Šæ”¾å±å¹•å¸¸äº®
            els.startBtn.textContent = "ç»§ç»­";
            document.body.classList.remove('focus-mode');
            document.title = "ä¸“æ³¨è®¡æ—¶å™¨ Pro";
        }

        function resetTimer() {
            pauseTimer();
            currentSessionType = 'work';
            timeLeft = appState.settings.workTime * 60;
            totalTime = timeLeft;
            promptTimeTarget = 0;
            els.startBtn.textContent = "å¼€å§‹ä¸“æ³¨";
            updateTimerUI(timeLeft, totalTime);
            updateStatusUI();
        }

        // æ¯ä¸€ç§’æ‰§è¡Œä¸€æ¬¡ (Worker è§¦å‘)
        function tick() {
            timeLeft--;
            updateTimerUI(timeLeft, totalTime);

            // éšæœºæç¤º
            if (currentSessionType === 'work' && timeLeft === promptTimeTarget) {
                triggerShortBreak();
            }

            // ç»“æŸ
            if (timeLeft <= 0) {
                switchPhase();
            }
        }

        function switchPhase() {
            timerWorker.postMessage('stop'); // å…ˆæš‚åœ

            if (currentSessionType === 'work') {
                playSound('longBreak');
                showNotification("ä¸“æ³¨ç»“æŸï¼Œå¼€å§‹ä¼‘æ¯");
                appState.stats.sessionCount++;
                document.getElementById('session-count').textContent = appState.stats.sessionCount;
                saveSettings();

                currentSessionType = 'longBreak';
                timeLeft = appState.settings.restTime * 60;
            } else {
                playSound('work');
                showNotification("ä¼‘æ¯ç»“æŸï¼Œå¼€å§‹å·¥ä½œ");
                currentSessionType = 'work';
                timeLeft = appState.settings.workTime * 60;
                promptTimeTarget = 0;
                scheduleNextPrompt();
            }

            totalTime = timeLeft;
            updateStatusUI();

            // ç¨å¾®å»¶è¿Ÿåè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€é˜¶æ®µ
            setTimeout(() => {
                timerWorker.postMessage('start');
            }, 1000);
        }

        function triggerShortBreak() {
            timerWorker.postMessage('stop');
            playSound('shortBreak');
            createFloatingNote("â˜•");
            showNotification("æ”¾æ¾ 10 ç§’é’Ÿ...");

            const prevType = currentSessionType;
            const prevTime = timeLeft;
            const prevTotal = totalTime;

            currentSessionType = 'shortBreak';
            timeLeft = 10;
            totalTime = 10;
            updateStatusUI();

            // å¯åŠ¨10ç§’å€’è®¡æ—¶
            let breakInterval = setInterval(() => {
                timeLeft--;
                updateTimerUI(timeLeft, totalTime);
                if (timeLeft <= 0) {
                    clearInterval(breakInterval);
                    // æ¢å¤
                    currentSessionType = prevType;
                    timeLeft = prevTime;
                    totalTime = prevTotal;
                    playSound('work');
                    updateStatusUI();
                    scheduleNextPrompt();
                    timerWorker.postMessage('start'); // æ¢å¤ä¸»è®¡æ—¶
                }
            }, 1000);
        }

        function scheduleNextPrompt() {
            const min = appState.settings.minPrompt * 60;
            const max = appState.settings.maxPrompt * 60;
            const interval = Math.floor(Math.random() * (max - min + 1)) + min;
            if (timeLeft - interval > 60) promptTimeTarget = timeLeft - interval;
            else promptTimeTarget = -1;
        }

        /**
         * UI æ›´æ–°
         */
        function updateTimerUI(seconds, total) {
            if (seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            els.timer.textContent = `${m}:${s}`;

            if (isRunning) {
                const icon = currentSessionType === 'work' ? 'ğŸ’»' : 'â˜•';
                document.title = `${m}:${s} ${icon}`;
            }

            const progress = total > 0 ? ((total - seconds) / total) * 100 : 0;
            els.progressBar.style.width = `${progress}%`;
        }

        function updateStatusUI() {
            els.status.className = 'status-badge ' + (currentSessionType === 'work' ? 'work' : (currentSessionType === 'shortBreak' ? 'short-break' : 'long-break'));
            const texts = { work: 'ä¸“æ³¨å·¥ä½œ', shortBreak: 'å¿«é€Ÿæ”¾æ¾', longBreak: 'ä¼‘æ¯æ—¶é—´' };
            els.status.textContent = texts[currentSessionType];
            document.getElementById('current-mode-text').textContent = texts[currentSessionType];
        }

        function updateSoundEditorUI() {
            const params = appState.soundParams[editingSoundType];
            els.soundControls.volume.value = params.volume;
            els.soundControls.pitch.value = params.pitch;
            document.getElementById('val-volume').textContent = params.volume + '%';
            els.soundControls.harmonics.forEach((h, i) => {
                if(params.harmonics[i] !== undefined) h.value = params.harmonics[i];
            });
        }

        function showNotification(msg) {
            els.notification.textContent = msg;
            els.notification.classList.add('show');
            setTimeout(() => els.notification.classList.remove('show'), 2500);
        }

        function createFloatingNote(char) {
            const note = document.createElement('div');
            note.className = 'floating-note';
            note.textContent = char;
            note.style.left = Math.random() * 60 + 20 + '%';
            note.style.top = '50%';
            note.style.color = `hsl(${Math.random()*360}, 80%, 70%)`;
            document.body.appendChild(note);
            setTimeout(() => note.remove(), 4000);
        }

        // é¢„è®¾é€‰æ‹©
        window.selectPreset = function(type) {
            const presets = {
                piano: { pitch: 50, decay: 60, brightness: 70, harmonics: [40, 30, 20, 10] },
                bell: { pitch: 75, decay: 40, brightness: 85, harmonics: [30, 20, 10, 5] },
                gong: { pitch: 30, decay: 90, brightness: 60, harmonics: [50, 40, 30, 20] },
                beep: { pitch: 60, decay: 20, brightness: 90, harmonics: [0, 0, 0, 0] }
            };
            if (presets[type]) {
                Object.assign(appState.soundParams[editingSoundType], presets[type], { type });
                updateSoundEditorUI();
                initAudioContext();
                playSound(editingSoundType);
                saveSettings();
            }
        };

        /**
         * å£°éŸ³æ’­æ”¾å¼•æ“ (ä¿æŒä¸å˜)
         */
        function playSound(typeKey) {
            if (!soundEnabled || !audioContext) return;
            const params = appState.soundParams[typeKey];
            const now = audioContext.currentTime;
            const vol = params.volume / 100;
            const pitchMult = 0.5 + (params.pitch / 100) * 1.5;
            const decay = 0.5 + (params.decay / 100) * 3.0;

            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.type = params.type === 'beep' ? 'square' : (params.type === 'gong' ? 'sine' : 'triangle');
            if (params.type === 'piano') osc.type = 'sine';

            let baseFreq = 440 * pitchMult;
            if (params.type === 'gong') baseFreq = 150 * pitchMult;
            if (params.type === 'bell') baseFreq = 800 * pitchMult;

            osc.frequency.setValueAtTime(baseFreq, now);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + decay);

            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(now);
            osc.stop(now + decay);

            if (params.type !== 'beep') {
                params.harmonics.forEach((hVal, i) => {
                    if (hVal <= 0) return;
                    const hOsc = audioContext.createOscillator();
                    const hGain = audioContext.createGain();
                    hOsc.frequency.value = baseFreq * (i + 2);
                    const hVol = (hVal / 100) * vol;
                    hGain.gain.setValueAtTime(0, now);
                    hGain.gain.linearRampToValueAtTime(hVol, now + 0.05);
                    hGain.gain.exponentialRampToValueAtTime(0.001, now + decay * 0.8);
                    hOsc.connect(hGain);
                    hGain.connect(audioContext.destination);
                    hOsc.start(now);
                    hOsc.stop(now + decay);
                });
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
